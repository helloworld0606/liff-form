<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>AIè‡ªå‹•åŒ–å·¥ä½œæµä¹‹è¡“</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    label { font-weight: bold; margin-top: 10px; display: block; }
    input, textarea, select, button {
      display: block; width: 100%; margin: 6px 0 12px; padding: 10px;
      font-size: 16px; border: 1px solid #ccc; border-radius: 6px;
    }
    button.submit-btn.loading { background-color: #ccc; cursor: wait; }
    .message {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      padding: 12px 24px; border-radius: 8px; color: white; font-weight: 500;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <h2>è³‡æ–™å¡«å¯«</h2>
  <form id="agentForm">
    <label for="name">å§“å<span style="color:red">*</span></label>
    <input type="text" name="name" id="name" required />

    <label for="phone">é›»è©±<span style="color:red">*</span></label>
    <input type="text" name="phone" id="phone" required />

    <label for="email">é›»å­éƒµä»¶<span style="color:red">*</span></label>
    <input type="email" name="email" id="email" required />

        <label for="level">æˆ‘æ˜¯<span style="color:red">*</span></label>
    <select name="level" id="level" required>
      <option value="">è«‹é¸æ“‡</option>
      <option value="student">å­¸ç”Ÿ</option>
      <option value="startup">è‡ªåƒ±/å€‹äººå•†åº—</option>
      <option value="pro">ä¸Šç­æ—</option>
      <option value="company">ä¸­å°ä¼æ¥­</option>
    </select>

    <!-- <label for="message">æˆæ¬Šä»£ç¢¼<span style="color:red">*</span></label>
    <input type="text" name="code" id="code" required/> -->

    <button type="submit" class="submit-btn">é€å‡º</button>
    <button type="button" class="close-btn">é—œé–‰</button>
  </form>

  <script>
document.addEventListener("DOMContentLoaded", function () {
  if (!navigator.userAgent.includes("Line")) {
    alert("è«‹ä½¿ç”¨ LINE App é–‹å•Ÿæ­¤é é¢ï¼Œä»¥ä½¿ç”¨å®Œæ•´åŠŸèƒ½");
    return;
  }
  initLiffAndBindForm();
});

async function initLiffAndBindForm() {
  const form = document.getElementById("agentForm");
  const submitBtn = document.querySelector(".submit-btn");
  const closeBtn = document.querySelector(".close-btn");
  if (!form || !submitBtn || !closeBtn) return;

  let lineUserId = null;
  try {
    await liff.init({ liffId: "2007970219-gN63PMKn" });
    if (!liff.isInClient()) {
      alert("è«‹é€é LINE App é–‹å•Ÿæ­¤è¡¨å–®ï¼Œå¦å‰‡ç„¡æ³•å–å¾—æ‚¨çš„èº«ä»½è³‡è¨Š");
      return;
    }
    if (!liff.isLoggedIn()) {
      liff.login(); return;
    }
    const profile = await liff.getProfile();
    lineUserId = profile.userId;
  } catch (err) {
    alert("LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¢ºèªæ˜¯å¦é€é LINE App é–‹å•Ÿæ­¤é é¢");
    return;
  }

  // ğŸ” æŸ¥è©¢æ˜¯å¦å·²å¡«é
  try {
    const checkRes = await fetch(`https://n8n-dev.site/webhook/check-user?userId=${lineUserId}`);
    const checkData = await checkRes.json();
    if (checkData?.alreadySubmitted) {
      showMessage("æ‚¨å·²å¡«å¯«éæ­¤è¡¨å–®ï¼Œç„¡éœ€é‡è¤‡æäº¤", "error");
      form.querySelectorAll("input, select, textarea, button").forEach(el => el.disabled = true);
      return;
    }
  } catch (err) {
    console.warn("âš ï¸ ç„¡æ³•ç¢ºèªæ˜¯å¦å·²å¡«éï¼Œå°‡ç¹¼çºŒæäº¤æµç¨‹");
  }

  // âœ… å³æ™‚é©—è­‰
  form.querySelectorAll("input, select, textarea").forEach(field => {
    field.addEventListener("input", () => {
      if (!field.value.trim()) {
        field.style.borderColor = "#e74c3c";
      } else {
        field.style.borderColor = "#27ae60";
      }

      if (field.id === "phone" && field.value && !/^[0-9]+$/.test(field.value)) {
        field.style.borderColor = "#e74c3c";
      }

      if (field.id === "email" && field.value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(field.value)) {
        field.style.borderColor = "#e74c3c";
      }
    });
  });

  closeBtn.addEventListener("click", () => {
    if (confirm("ç¢ºå®šè¦é—œé–‰è¡¨å–®å—ï¼Ÿæœªä¿å­˜çš„è³‡æ–™å°‡æœƒéºå¤±ã€‚")) window.close();
  });

  function showMessage(message, type = "info") {
    const existing = document.querySelector(".message");
    if (existing) existing.remove();
    const msg = document.createElement("div");
    msg.className = `message ${type}`;
    msg.textContent = message;
    msg.style.backgroundColor = type === "error" ? "#e74c3c" : "#27ae60";
    document.body.appendChild(msg);
    setTimeout(() => msg.remove(), 3000);
  }

  function validateForm() {
    let isValid = true;
    const phoneField = document.getElementById("phone");
    const emailField = document.getElementById("email");
    const requiredFields = form.querySelectorAll("[required]");
    requiredFields.forEach(field => {
      if (!field.value.trim()) {
        field.style.borderColor = "#e74c3c"; isValid = false;
      } else {
        field.style.borderColor = "#27ae60";
      }
    });

    const phoneValue = phoneField.value.trim();
    if (!/^[0-9]+$/.test(phoneValue)) {
      phoneField.style.borderColor = "#e74c3c";
      showMessage("è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»è©±è™Ÿç¢¼ï¼ˆåƒ…é™æ•¸å­—ï¼‰", "error");
      isValid = false;
    }

    const emailValue = emailField.value.trim();
    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailPattern.test(emailValue)) {
      emailField.style.borderColor = "#e74c3c";
      showMessage("è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€", "error");
      isValid = false;
    }

    return isValid;
  }

  form.addEventListener("submit", async function (e) {
    e.preventDefault();
    if (!validateForm()) {
      showMessage("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ä¸¦ç¢ºä¿æ ¼å¼æ­£ç¢º", "error");
      return;
    }

    submitBtn.classList.add("loading");
    submitBtn.disabled = true;

    const formData = new FormData(form);
    const data = {};
    for (let [key, value] of formData.entries()) {
      data[key] = value;
    }
    data.lineUserId = lineUserId;

    try {
      const response = await fetch("https://n8n-dev.site/webhook/0d368ce6-652e-494d-91da-7e029c862659", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`HTTP error! status: ${response.status}, response: ${errorText}`);
      }

      const result = await response.json();
      showMessage("è³‡æ–™å·²æˆåŠŸæäº¤ï¼", "success");
      form.reset();
      form.querySelectorAll("input, select, textarea, button").forEach(el => el.disabled = true);
    } catch (error) {
      console.error("âŒ æäº¤è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
      showMessage("æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", "error");
    } finally {
      submitBtn.classList.remove("loading");
      submitBtn.disabled = false;
    }
  });
}
</script>

</body>
</html>
